% Caracteres utilizados
% 
% @ comienza experimento       = 0x40 = 64
% $ finaliza el experimento    = 0x24 = 36
% % comienza estimulo 1        = 0x25 = 
% & finaliza estimulo 1        = 0x26 = 
% # comienza estimulo 2        = 0x23 = 35
% ! finaliza estimulo 2        = 0x21 = 33

function [opcion] = script_Principal( vectorDatos, vectorMarcas )

 % Inversión de los vectores
vectorDatos = vectorDatos';
vectorMarcas = vectorMarcas';

 % Defines para segmentar los datos
INICIO_ELECCION = uint8('@');
FIN_ELECCION    = uint8('$');
MARCA_SI        = uint8('%');
MARCA_NO        = uint8('#');
CANT_MUESTRAS   = 128;
fs              = 250;

 % Defines de los filtros
 
  % Filtro notch de 50 Hz con Fs = 250Hz
  numNotch50 = [ 0.5792   -0.3580    0.5792 ];
  denNotch50 = [ 1.0000   -0.3580    0.1584 ];
  
  % Filtro notch de 100 Hz con Fs = 250Hz
  numNotch100 = [ 0.2452    0.3968    0.2452 ];
  denNotch100 = [ 1.0000    0.3968   -0.5095 ];

  % Filtro pasa altos con Fp = 0.5; Fstop = 0.05; Attp = 1; Atts = 20
  numPasaAltos = [-0.0459782058928512 -0.000829667445663389 -0.000836977296603120 -0.000845099806584692 -0.000852097189703727 -0.000859902910896948 -0.000866534758476477 -0.000874206839141219 -0.000880778221187929 -0.000888332138240629 -0.000894483915838989 -0.000901695611651723 -0.000908116713733249 -0.000915019190345896 -0.000921081281854161 -0.000928026355523511 -0.000933881824382252 -0.000940999706253167 -0.000946783740055399 -0.000954285760183647 -0.000960178644148816 -0.000968416375535379 -0.000975304610160576 -0.000984129237639881 -0.000992070793874723 -0.00100297153381367 -0.00101258744623351 -0.00102618717244736 -0.00103805152954071 -0.00105648893978720 -0.00107181336494831 -0.00110280560518585 -0.00100529272133808 -0.00106682420003084 -0.00108170801275997 -0.00108674577667725 -0.00109733148647097 -0.00110356924919190 -0.00111334837836873 -0.00112002215787303 -0.00112916024107026 -0.00113583278449237 -0.00114469806269080 -0.00115165801769711 -0.00115983558725679 -0.00116675214456500 -0.00117494150457842 -0.00118179373485420 -0.00119009068301713 -0.00119698650062434 -0.00120559467161912 -0.00121269505896667 -0.00122191209126371 -0.00122949488329630 -0.00123857556034865 -0.00124706720776843 -0.00125681008740912 -0.00126507182522810 -0.00127466526568201 -0.00128210713573194 -0.00129077121827151 -0.00129498263813755 -0.00129978865648730 -0.00129231007433272 -0.00132736207364206 -0.00132785074537353 -0.00133254483101875 -0.00134176453821816 -0.00134825232674078 -0.00135674922228205 -0.00136336077023515 -0.00137132183488356 -0.00137799587512397 -0.00138577956378115 -0.00139241667525756 -0.00139966483942269 -0.00140655485680311 -0.00141390561805117 -0.00142075071996644 -0.00142829992352834 -0.00143521424287629 -0.00144308361587762 -0.00145009113648993 -0.00145829735992912 -0.00146517653095609 -0.00147309721670906 -0.00148069030468737 -0.00148803205587526 -0.00149464195193720 -0.00150168853947526 -0.00150773400750745 -0.00151439461247752 -0.00151972085317018 -0.00152731686417926 -0.00153460383813232 -0.00155201421013603 -0.00154904656358761 -0.00155681342603743 -0.00156578744893451 -0.00157166473157747 -0.00157937629400549 -0.00158540145154037 -0.00159276268270009 -0.00159896335394422 -0.00160611873573274 -0.00161228137741454 -0.00161926406705178 -0.00162587586445291 -0.00163282894883635 -0.00163937199197435 -0.00164649256252930 -0.00165300375381908 -0.00166024479620480 -0.00166656975646067 -0.00167378683641643 -0.00167967609202899 -0.00168677484393518 -0.00169303366211991 -0.00169885140166164 -0.00170487492671485 -0.00171132326450638 -0.00171734621933770 -0.00172402847117650 -0.00173037037934122 -0.00173823076850851 -0.00174505574086883 -0.00175290390930737 -0.00175231881952120 -0.00176240488322927 -0.00176911555378769 -0.00177370086911690 -0.00178025606035993 -0.00178539057807299 -0.00179168708744447 -0.00179697028067862 -0.00180302056477233 -0.00180836496709519 -0.00181439478126399 -0.00181997906732375 -0.00182566947798655 -0.00183111102978173 -0.00183683167847176 -0.00184202962241068 -0.00184763755823973 -0.00185246683638120 -0.00185796236242586 -0.00186244631080923 -0.00186808246271312 -0.00187256620259491 -0.00187709966663270 -0.00188267956892509 -0.00188786746199628 -0.00189285407543973 -0.00189807378972512 -0.00190308370911370 -0.00190837249413329 -0.00191237401560467 -0.00191649653945999 -0.00191879982805215 -0.00192741760552213 -0.00193043147170726 -0.00193368007675656 -0.00193892219318643 -0.00194259005429672 -0.00194740730824578 -0.00195118048765996 -0.00195575737279087 -0.00195962686224235 -0.00196405668597520 -0.00196784571366303 -0.00197179872636049 -0.00197552016538265 -0.00197941673656262 -0.00198280167802095 -0.00198657733365553 -0.00198970619858943 -0.00199354387891366 -0.00199653189880460 -0.00200058686111446 -0.00200330787582982 -0.00200691640347320 -0.00201124978837651 -0.00201404711035118 -0.00201716000848781 -0.00202033989520052 -0.00202334420234212 -0.00202619707033141 -0.00202840632165289 -0.00203126932529296 -0.00203400139103833 -0.00203884804016684 -0.00203901998667705 -0.00204176994271916 -0.00204538390402841 -0.00204726840395014 -0.00205029424900335 -0.00205228304066801 -0.00205500347132248 -0.00205696674825961 -0.00205933174815887 -0.00206109090080758 -0.00206310395558926 -0.00206493958410064 -0.00206683380021950 -0.00206837029195143 -0.00207029415274577 -0.00207173897314098 -0.00207379330837821 -0.00207506824590562 -0.00207718387192289 -0.00207805681204676 -0.00208022141430232 -0.00208200999855987 -0.00208184294830211 -0.00208347104613330 -0.00208463682479138 -0.00208569341150630 -0.00208640682112669 -0.00208716154604662 -0.00208839723235342 -0.00208940259488040 -0.00209055753031004 -0.00208955182547743 -0.00209157783817575 -0.00209275572651420 -0.00209248938462674 -0.00209354470732966 -0.00209345103092699 -0.00209412314434531 -0.00209396302698555 -0.00209430385446514 -0.00209411612678679 -0.00209433809547838 0.997905698871424 -0.00209433809547838 -0.00209411612678679 -0.00209430385446514 -0.00209396302698555 -0.00209412314434531 -0.00209345103092699 -0.00209354470732966 -0.00209248938462674 -0.00209275572651420 -0.00209157783817575 -0.00208955182547743 -0.00209055753031004 -0.00208940259488040 -0.00208839723235342 -0.00208716154604662 -0.00208640682112669 -0.00208569341150630 -0.00208463682479138 -0.00208347104613330 -0.00208184294830211 -0.00208200999855987 -0.00208022141430232 -0.00207805681204676 -0.00207718387192289 -0.00207506824590562 -0.00207379330837821 -0.00207173897314098 -0.00207029415274577 -0.00206837029195143 -0.00206683380021950 -0.00206493958410064 -0.00206310395558926 -0.00206109090080758 -0.00205933174815887 -0.00205696674825961 -0.00205500347132248 -0.00205228304066801 -0.00205029424900335 -0.00204726840395014 -0.00204538390402841 -0.00204176994271916 -0.00203901998667705 -0.00203884804016684 -0.00203400139103833 -0.00203126932529296 -0.00202840632165289 -0.00202619707033141 -0.00202334420234212 -0.00202033989520052 -0.00201716000848781 -0.00201404711035118 -0.00201124978837651 -0.00200691640347320 -0.00200330787582982 -0.00200058686111446 -0.00199653189880460 -0.00199354387891366 -0.00198970619858943 -0.00198657733365553 -0.00198280167802095 -0.00197941673656262 -0.00197552016538265 -0.00197179872636049 -0.00196784571366303 -0.00196405668597520 -0.00195962686224235 -0.00195575737279087 -0.00195118048765996 -0.00194740730824578 -0.00194259005429672 -0.00193892219318643 -0.00193368007675656 -0.00193043147170726 -0.00192741760552213 -0.00191879982805215 -0.00191649653945999 -0.00191237401560467 -0.00190837249413329 -0.00190308370911370 -0.00189807378972512 -0.00189285407543973 -0.00188786746199628 -0.00188267956892509 -0.00187709966663270 -0.00187256620259491 -0.00186808246271312 -0.00186244631080923 -0.00185796236242586 -0.00185246683638120 -0.00184763755823973 -0.00184202962241068 -0.00183683167847176 -0.00183111102978173 -0.00182566947798655 -0.00181997906732375 -0.00181439478126399 -0.00180836496709519 -0.00180302056477233 -0.00179697028067862 -0.00179168708744447 -0.00178539057807299 -0.00178025606035993 -0.00177370086911690 -0.00176911555378769 -0.00176240488322927 -0.00175231881952120 -0.00175290390930737 -0.00174505574086883 -0.00173823076850851 -0.00173037037934122 -0.00172402847117650 -0.00171734621933770 -0.00171132326450638 -0.00170487492671485 -0.00169885140166164 -0.00169303366211991 -0.00168677484393518 -0.00167967609202899 -0.00167378683641643 -0.00166656975646067 -0.00166024479620480 -0.00165300375381908 -0.00164649256252930 -0.00163937199197435 -0.00163282894883635 -0.00162587586445291 -0.00161926406705178 -0.00161228137741454 -0.00160611873573274 -0.00159896335394422 -0.00159276268270009 -0.00158540145154037 -0.00157937629400549 -0.00157166473157747 -0.00156578744893451 -0.00155681342603743 -0.00154904656358761 -0.00155201421013603 -0.00153460383813232 -0.00152731686417926 -0.00151972085317018 -0.00151439461247752 -0.00150773400750745 -0.00150168853947526 -0.00149464195193720 -0.00148803205587526 -0.00148069030468737 -0.00147309721670906 -0.00146517653095609 -0.00145829735992912 -0.00145009113648993 -0.00144308361587762 -0.00143521424287629 -0.00142829992352834 -0.00142075071996644 -0.00141390561805117 -0.00140655485680311 -0.00139966483942269 -0.00139241667525756 -0.00138577956378115 -0.00137799587512397 -0.00137132183488356 -0.00136336077023515 -0.00135674922228205 -0.00134825232674078 -0.00134176453821816 -0.00133254483101875 -0.00132785074537353 -0.00132736207364206 -0.00129231007433272 -0.00129978865648730 -0.00129498263813755 -0.00129077121827151 -0.00128210713573194 -0.00127466526568201 -0.00126507182522810 -0.00125681008740912 -0.00124706720776843 -0.00123857556034865 -0.00122949488329630 -0.00122191209126371 -0.00121269505896667 -0.00120559467161912 -0.00119698650062434 -0.00119009068301713 -0.00118179373485420 -0.00117494150457842 -0.00116675214456500 -0.00115983558725679 -0.00115165801769711 -0.00114469806269080 -0.00113583278449237 -0.00112916024107026 -0.00112002215787303 -0.00111334837836873 -0.00110356924919190 -0.00109733148647097 -0.00108674577667725 -0.00108170801275997 -0.00106682420003084 -0.00100529272133808 -0.00110280560518585 -0.00107181336494831 -0.00105648893978720 -0.00103805152954071 -0.00102618717244736 -0.00101258744623351 -0.00100297153381367 -0.000992070793874723 -0.000984129237639881 -0.000975304610160576 -0.000968416375535379 -0.000960178644148816 -0.000954285760183647 -0.000946783740055399 -0.000940999706253167 -0.000933881824382252 -0.000928026355523511 -0.000921081281854161 -0.000915019190345896 -0.000908116713733249 -0.000901695611651723 -0.000894483915838989 -0.000888332138240629 -0.000880778221187929 -0.000874206839141219 -0.000866534758476477 -0.000859902910896948 -0.000852097189703727 -0.000845099806584692 -0.000836977296603120 -0.000829667445663389 -0.0459782058928512 ];
  denPasaAltos = zeros( 1, length( numPasaAltos ) );
  denPasaAltos(1) = 1;
  
  % Filtro pasa bajos con Fp = 30; Fstop = 50; Attp = 1; Atts = 10
  numPasaBajos = [-0.124287895230207 0.0907775119358351 0.219375525290769 0.322765938328756 0.322765938328756 0.219375525290769 0.0907775119358351 -0.124287895230207];
  denPasaBajos = zeros( 1, length( numPasaBajos ) );
  denPasaBajos(1) = 1;
  

 % Aplicación de los filtros
 vectorDatos = filter( numNotch50, denNotch50, vectorDatos );       % Notch de 50 Hz
 vectorDatos = filter( numNotch100, denNotch100, vectorDatos );     % Notch de 100 Hz
 vectorDatos = filter( numPasaAltos, denPasaAltos, vectorDatos );   % Pasa altos
 vectorDatos = filter( numPasaBajos, denPasaBajos, vectorDatos );   % Pasa bajos

% Armado de un vector con los datos de la señal y los markers
temp = { vectorDatos, vectorMarcas };
    
    
%% Segmentado de EEG

%Obtengo elecciones
eleccion = CortarEleccion(temp,INICIO_ELECCION,FIN_ELECCION);

siCortados = {zeros(length(eleccion))};
noCortados = {zeros(length(eleccion))};
siPromedio = {zeros(CANT_MUESTRAS)};
noPromedio = {zeros(CANT_MUESTRAS)};
siNormalizado = {zeros(CANT_MUESTRAS)};
noNormalizado = {zeros(CANT_MUESTRAS)};
siEnergiaPost={};
noEnergiaPost={};

for elec = 1 : length(eleccion)
    
    %Como no estÃ¡n divididos, corto todos los SI y los NO
    siCortados{elec} = CortarNMuestras(eleccion{elec},MARCA_SI,CANT_MUESTRAS);
    noCortados{elec} = CortarNMuestras(eleccion{elec},MARCA_NO,CANT_MUESTRAS);

    %Ahora tengo que promediarlas!!
    % http://stackoverflow.com/questions/5197597/how-to-average-over-a-cell-array-of-arrays
    
    siPromedio{elec}= Promediar(siCortados{elec},1);
    noPromedio{elec}= Promediar(noCortados{elec},1);
    
    siNormalizado{elec}=Normalizar(siPromedio{elec},1);
    noNormalizado{elec}=Normalizar(noPromedio{elec},1);
 
%% Ploteo de resultados obtenidos en tiempo
    
%     ejeX        = 'Tiempo';
%     ejeY        = 'Amplitud[V]';
%     gridEstado  = 0;
%     nMuestras   = length(siNormalizado{elec});
%     xTemp       = 0:1/fs:(nMuestras-1)*1/fs;
%     titulo      = 'Resultados superpuestos antes de aplicar wavelet';
%     plotTiempo(siNormalizado{elec},noNormalizado{elec},elec,xTemp,titulo,ejeX,ejeY,gridEstado);
    
    %% Procesamiento (wavelet) y informacion de energia
    % De la forma (1) está normalizada la energía y da el mismo valor de
    % energía para ambas señales. Acá le saqué la normalización.
    
    verificacionEnergia(siPromedio{elec},noPromedio{elec},0);
    resultado = Procesar(siPromedio{elec},noPromedio{elec},5,'noplot');
     
    %% Continua procesamiento (Wavelet) y información de energía
    energiaTemp=verificacionEnergia(resultado{1},resultado{2},1);

%% Ploteo de resultados obtenidos en tiempo
    
%     ejeX        = 'Tiempo';
%     ejeY        = 'Amplitud[V]';
%     gridEstado  = 0;
%     nMuestras = length(siNormalizado{elec}); xTemp = 0:1/fs:(nMuestras-1)*1/fs;
%     titulo     = 'Resultados superpuestos';
%     plotTiempo(resultado{1},resultado{2},elec,xTemp,titulo,ejeX,ejeY,gridEstado);
    
%% Evaluacion de eleccion por energias (250mS a 350mSeg estandar)

    inicioP300=round(fs*0.300);
    finP300=round(fs*0.450);
    opcion = EvaluarEleccion(resultado{1},resultado{2},elec, inicioP300,finP300);
    
    if( opcion == 1 )
        opcion = 'SI';
    else
        opcion = 'NO';
    end
    
end

end